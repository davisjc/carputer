#!/bin/sh
#
# Carputer transport device mount script.
#
# Mounts a recognized carputer transport device as determined by $_TRANSPORT_ID.
#
# When plugged into the carputer, also triggers work to sync with the transport device.
#
# Can be executed by devmon (part of the udevil package) with arguments such as:
#
#     $ devmon --exec-on-drive "/path/to/this/script %f %d"
#
# @author: Johnathan Davis


_DEVICE=$1
_MNT=$2

_SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

source "${_SCRIPT_DIR}/music_sync_vars"

if [[ -f "${_MNT}/${_TRANSPORT_ID_FILE}" && $(cat "${_MNT}/${_TRANSPORT_ID_FILE}") == "$_TRANSPORT_ID" ]]; then
    udevil umount $_DEVICE
    udevil mount $_DEVICE $_TRANSPORT_DIR
    if [[ "$(hostname)" == "$_CARPUTER_HOST" ]]; then
        # Trigger carputer update.
        $_SCRIPT_DIR/music_sync_to_carputer

        # TODO
        # udevil umount $_DEVICE
    fi
fi

