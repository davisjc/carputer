#!/bin/sh
#
# Carputer transport device mount script.
#
# Mounts a recognized carputer transport device as determined by $_TRANSPORT_ID.
#
# When plugged into the carputer, also triggers work to sync with the transport device.
#
# Can be executed by devmon (part of the udevil package) with arguments such as:
#
#     $ devmon --exec-on-drive "/path/to/this/script %f %d"
#
# @author: Johnathan Davis


DEVICE=$1
MNT=$2

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

source "${SCRIPT_DIR}/music_sync_vars"

if [[ -f "${MNT}/${TRANSPORT_ID_FILE}" && $(cat "${MNT}/${TRANSPORT_ID_FILE}") == "$TRANSPORT_ID" ]]; then
    udevil umount "$DEVICE"
    udevil mount "$DEVICE" "$TRANSPORT_DIR"
    if [[ "$(hostname)" == "$CARPUTER_HOST" ]]; then
        "${SCRIPT_DIR}/light_blink" &
        pid_blink=$!

        # TODO get mpd to stop auto-updating so we don't have to take it down.
        sudo systemctl stop mpd.service

        # Trigger carputer update.
        "$SCRIPT_DIR/music_sync_to_carputer"

        sudo systemctl start mpd.service

        udevil umount "$DEVICE"

        kill $pid_blink
        "${SCRIPT_DIR}/light_set" 0
    fi
fi

