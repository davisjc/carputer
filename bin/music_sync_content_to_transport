#!/bin/sh
#
# Copies missing music files to the carputer transport device.
#
# @author: Johnathan Davis

if [[ "$#" -lt 1 ]]; then
    echo "Please specify music directory."
    kill -INT $$
fi
if [[ "$#" -lt 2 ]]; then
    echo "Please specify transport directory."
    kill -INT $$
fi

_SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

source "${_SCRIPT_DIR}/music_sync_vars"

list_pc="${_TRANSPORT_DIR}/$_LIST_PC"
list_car="${_TRANSPORT_DIR}/$_LIST_CAR"
music_pc="$_MUSIC_DIR"
music_transport="${_TRANSPORT_DIR}/music"

if [[ ! -f "$list_pc" ]]; then
    echo "List of files on pc not found: $list_pc"
    kill -INT $$
fi
if [[ ! -f "$list_car" ]]; then
    echo "List of files on car not found: $list_car"
    kill -INT $$
fi

echo -n "Removing any old music files from transport device... "
rm -r $music_transport 2> /dev/null
mkdir $music_transport
echo "Done"
echo ""

files_to_copy=$(LC_COLLATE=C comm $list_pc $list_car -23 | awk 'NF{NF-=2};1')
file_count=$(echo "$files_to_copy" | wc -l)

# TODO check available space

echo "Copying $file_count missing music file(s) to" \
     "transport device..."
echo ""

cd $music_pc
echo "$files_to_copy" | tr '\n' '\0' | \
    xargs -0 -L 1 -I {} cp -anv --parents "{}" $music_transport

echo ""
echo "Done with sync."

